# Standard library imports
import json
import socket
import threading
import logging
import time

# Third party imports


# Local application imports
from Module.kafkaProducer.wappalyzerScanProducer import WappalyzerScanProducers
from Module.kafkaProducer.wappalyzerOutputProducer import WappalyzerOutputProducers
from Config.config import WappalyzerAgents

class WappalyzerCaller(threading.Thread):
    def __init__(self, HOST, PORT, data):
        threading.Thread.__init__(self)
        self.HOST = HOST
        self.PORT = PORT
        self.data = data
        self.logger = logging.getLogger(__name__)

    def run(self):
        try:
            _startTime = int(time.time())

            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.connect((self.HOST, self.PORT))
                jData = json.dumps(self.data) + '\n'
                s.sendall(jData.encode('utf-8'))

                jOutputData = b''
                while True:
                    _data = s.recv(1024)
                    if not _data:
                        break
                    jOutputData += _data
            
            try: # To handle agents can send invalid data
                outputData = json.loads(jOutputData.decode('utf-8'))
                outputData["hostname"] = self.data.get("hostname")
                
                scan_stat = dict()
                scan_stat["startTime"] = _startTime
                scan_stat["endTime"] = int(time.time())
                scan_stat["duration"] = (scan_stat["endTime"] - scan_stat["startTime"])

                outputData["scanstat"] = scan_stat
                wappalyzerOutputProducer = WappalyzerOutputProducers()
                wappalyzerOutputProducer.sendDataToQueue(outputData)
            except:
                self.logger.exception("There are something wrong with return data from nmap Wappalyzer for target= {}: Recived data = {}".format(self.data, jOutputData))
                # self.resendDataToWapplyzerScanQueue()
        except:
            self.logger.exception("Something wrong when connect to nmap host at: " + str(self.HOST) + ":" + str(self.PORT))
            # self.resendDataToWapplyzerScanQueue()

    # def resendDataToWapplyzerScanQueue(self):
        # self.data['retryTimes'] = self.data['retryTimes'] + 1
        # wappalyzerScanProducer = WappalyzerScanProducers()
        # wappalyzerScanProducer.sendDataToQueue(self.data)