# Standard library imports
import json
import socket
import threading
import logging

# Third party imports


# Local application imports
from Module.kafkaProducer.nmapOutputProducer import NmapOutputProducers
from Module.kafkaProducer.nmapScanProducer import NmapScanProducers

class NmapCaller(threading.Thread):
    def __init__(self, HOST, PORT, data):
        threading.Thread.__init__(self)
        self.HOST = HOST
        self.PORT = PORT
        self.data = data
        self.logger = logging.getLogger(__name__)

    def run(self):
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.connect((self.HOST, self.PORT))
                data = self.data + '\n'
                s.sendall(data.encode('utf-8'))

                outputData = b''
                while True:
                    _data = s.recv(1024)
                    if not _data:
                        break
                    outputData += _data
            
            try: # Data can be not in json format
                jOutputData = json.loads(outputData)
                jOutputData["target"] = data
                nmapOutputProducer = NmapOutputProducers(jOutputData)
                nmapOutputProducer.sendDataToQueue()
            except:
                self.logger.exception("There are some error with return data from nmap Agent for target= {}: Data = {}".format(self.data, outputData))
        except:
            self.logger.exception("when connect to nmap host at: " + str(self.HOST) + ":" + str(self.PORT) + ".. Resend data to nmapScan queue")
            jData = json.loads(data)
            nmapScanProducer = NmapOutputProducers(jData)
            nmapScanProducer.sendDataToQueue()