# Standard library imports
import json
import threading

# Third party imports
from kafka import KafkaConsumer

# Local application imports
from Config.config import KafkaTopicNames, KafkaConfig, KafkaGroupIds
from Module.AgentCaller.nmapCaller import NmapCaller
from Module.kafkaProducer.elasticSendProducer import ElasticSendProducers
from Module.kafkaProducer.cveSeachScanProducer import CVESeachScanProducers
from Module.kafkaProducer.nseScanProducer import NseScanProducers

class NmapOutputConsumers(threading.Thread):
    def __init__(self):
        threading.Thread.__init__(self)
        #TODO: auto_comit = false
        self.consumer = KafkaConsumer(
                        KafkaTopicNames.NMAPOUTPUT,
                        bootstrap_servers       = KafkaConfig.BOOTSTRAPSERVER,
                        auto_offset_reset       = 'earliest',
                        enable_auto_commit      = True,
                        group_id                = KafkaGroupIds.NMAPOUTPUT,
                        value_deserializer      = lambda x: json.loads(x.decode('utf-8')))

    def run(self):
        for message in self.consumer:
            data = message.value

            print('added to nmapOutput Queue')

            elasticSendProducer = ElasticSendProducers(data)
            elasticSendProducer.sendDataToQueue()

            cve_SeachScanProducer = CVESeachScanProducers(data)
            cve_SeachScanProducer.sendDataToQueue()

            nseScanProducer = NseScanProducers(data)
            nseScanProducer.sendDataToQueue()


            

            

 